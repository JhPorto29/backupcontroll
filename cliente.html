<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Backups</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="script.js"></script> <!-- Certifique-se de que o script.js está sendo carregado -->
</head>
<body>
    <header class="banner">
        <div class="banner-content">
            <!-- Logo removido -->
        </div>
    </header>
    <h1 id="client-name">Controle de Backups</h1>

    <!-- Botão Home -->
    <div class="home-button">
        <button onclick="goHome()">Home</button>
    </div>

    <!-- Botão para página de transporte -->
    <div class="transport-button">
        <button onclick="goToTransport()">Gerar Documento de Transporte</button>
    </div>

    <!-- Contêiner de notificações -->
    <div id="notification-container" class="hidden"></div>

    <!-- Formulário para adicionar dados -->
    <form id="data-form">
        <label for="serial">ESN:</label>
        <input type="text" id="serial" name="serial" required>

        <label for="model">Modelo:</label>
        <input type="text" id="model" name="model" required>

        <label for="currie">Nome Courier:</label>
        <select id="currie" name="currie" required></select>

        <!-- Campo para adicionar novo courier diretamente -->
        <div class="form-group">
            <label for="new-courier">Adicionar Novo Courier:</label>
            <input type="text" id="new-courier" placeholder="Digite o nome do novo courier" oninput="filterCouriers()">
            
            <!-- Lista de nomes filtrados -->
            <ul id="courier-list" class="courier-list">
                <!-- Lista dinâmica de couriers será aqui -->
            </ul>
            <button type="button" class="btn btn-secondary" onclick="addNewCourier()">Adicionar Courier</button>
        </div>
        <div class="buttons">
            <button type="submit" id="add-serial-btn">Adicionar ESN</button>
        </div>
    </form>
    <h2>Dados Registrados</h2>
    <!-- Seção de pesquisa -->
    <div class="search-container">
        <select id="search-column">
            <option value="1">ESN</option>
            <option value="2">Modelo</option>
            <option value="3">Data</option>
            <option value="4">Nome Courier</option>
            <option value="5">Tempo no Sistema</option>
        </select>
        <input type="text" id="search-box" placeholder="Digite para pesquisar..." onkeyup="searchTable()">
    </div>
    <!-- Tabela de dados -->
    <table id="data-table">
        <thead>
            <tr>
                <th>#</th>
                <th>ESN</th>
                <th>Modelo</th>
                <th>Data</th>
                <th>Nome Courier</th>
                <th>Tempo no Sistema</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dados serão adicionados aqui -->
        </tbody>
    </table>
    <!-- Botões de Importar e Exportar (apenas uma vez) -->
    <div class="action-buttons">
        <input type="file" id="import-file" style="display:none;">
        <button type="button" id="import-btn">Importar Excel</button>
        <button id="export-btn">Exportar para Excel</button>
        <button id="generate-doc-btn">Gerar Documento</button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const client = urlParams.get('client');
            document.getElementById('client-name').textContent = `Controle de Backups - ${client}`;
        });

        function goHome() {
            window.location.href = 'index.html';
        }

        function goToTransport() {
            const urlParams = new URLSearchParams(window.location.search);
            const client = urlParams.get('client');
            window.location.href = `transporte.html?client=${client}`;
        }

        document.getElementById('data-form').addEventListener('submit', function(event) {
            event.preventDefault();

            var serial = document.getElementById('serial').value.toUpperCase();
            var model = document.getElementById('model').value.toUpperCase();
            var date = new Date().toISOString().split('T')[0]; // Data atual no formato YYYY-MM-DD
            var currie = document.getElementById('currie').value.toUpperCase();

            if (isDuplicateSerial(serial)) {
                alert("ESN já registrado!");
                document.getElementById('serial').style.borderColor = "red";
                return;
            }

            document.getElementById('serial').style.borderColor = ""; // Resetar cor da borda

            addNewEntry(serial, model, date, currie);
            document.getElementById('data-form').reset();
            sortTableByColumn(4); // Ordenar pela coluna dos nomes (Nome Courier)
        });

        function isDuplicateSerial(serial) {
            var table = document.getElementById('data-table').getElementsByTagName('tbody')[0];
            var rows = table.getElementsByTagName('tr');
            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].getElementsByTagName('td');
                if (cells[1].textContent === serial) {
                    return true;
                }
            }
            return false;
        }

        function addNewEntry(serial, model, date, currie) {
            var formattedDate = formatDateToBrazilian(date);
            var table = document.getElementById('data-table').getElementsByTagName('tbody')[0];
            var newRow = table.insertRow();

            var daysInSystem = calculateDaysInSystem(date);
            var daysColor = getDaysColor(daysInSystem);

            newRow.innerHTML = `
                <td>${table.rows.length + 1}</td>
                <td>${serial}</td>
                <td>${model}</td>
                <td>${formattedDate}</td>
                <td>${currie}</td>
                <td style="color: ${daysColor};">${daysInSystem} dias</td>
                <td><button onclick="removeRow(this)">Remover</button></td>
            `;
        }

        function removeRow(button) {
            var row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        function sortTableByColumn(columnIndex) {
            var table = document.getElementById('data-table');
            var rows = Array.from(table.rows).slice(1); // Ignorar a linha do cabeçalho
            rows.sort(function(a, b) {
                var cellA = a.cells[columnIndex].textContent.trim();
                var cellB = b.cells[columnIndex].textContent.trim();
                return cellA.localeCompare(cellB);
            });
            rows.forEach(function(row) {
                table.tBodies[0].appendChild(row);
            });
        }

        function formatDateToBrazilian(date) {
            if (!date || typeof date !== 'string') return date;
            var parts = date.split('-');
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function calculateDaysInSystem(date) {
            var currentDate = new Date();
            var entryDate = new Date(date);
            var timeDiff = Math.abs(currentDate - entryDate);
            var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
            return diffDays;
        }

        function getDaysColor(days) {
            if (days <= 30) {
                return 'green';
            } else if (days <= 60) {
                return 'orange';
            } else {
                return 'red';
            }
        }

        function filterCouriers() {
            var input = document.getElementById('new-courier').value.toUpperCase();
            var list = document.getElementById('courier-list');
            var items = list.getElementsByTagName('li');

            for (var i = 0; i < items.length; i++) {
                var txtValue = items[i].textContent || items[i].innerText;
                if (txtValue.toUpperCase().indexOf(input) > -1) {
                    items[i].style.display = "";
                } else {
                    items[i].style.display = "none";
                }
            }
        }

        function addNewCourier() {
            var newCourier = document.getElementById('new-courier').value;
            if (newCourier) {
                var select = document.getElementById('currie');
                var option = document.createElement('option');
                option.text = newCourier;
                option.value = newCourier;
                select.add(option);
                document.getElementById('new-courier').value = ''; // Limpar o campo de entrada
            }
        }

        document.getElementById('import-btn').addEventListener('click', function() {
            document.getElementById('import-file').click();
        });

        document.getElementById('import-file').addEventListener('change', function(event) {
            var file = event.target.files[0];
            var reader = new FileReader();
            
            reader.onload = function(e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                var jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                jsonData.forEach(function(row, index) {
                    if (index === 0) return; // Ignorar cabeçalho
                    var serial = row[0];
                    var model = row[1];
                    var dateExcelFormat = row[2];
                    var currie = row[3];

                    // Corrigir a data do Excel para o formato correto
                    if (typeof dateExcelFormat === 'number') {
                        dateExcelFormat = formatDateFromExcel(dateExcelFormat);
                    } else if (typeof dateExcelFormat === 'string') {
                        dateExcelFormat = formatDateString(dateExcelFormat);
                    }

                    addNewEntry(serial, model, dateExcelFormat, currie);
                });
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('export-btn').addEventListener('click', function() {
            var table = document.getElementById('data-table');
            var wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, 'dados.xlsx');
        });

        function formatDateFromExcel(excelDate) {
            // Corrigir a data do Excel para o formato correto
            if (typeof excelDate === 'number') {
                const dateOffset = Math.floor(excelDate - 25569);
                const newDate = new Date(dateOffset * 86400 * 1000);
                return newDate.toISOString().split('T')[0];
            }
            return excelDate;
        }

        function formatDateString(dateString) {
            // Formatar a string de data para o formato correto
            const parts = dateString.split('/');
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
    </script>
</body>
</html>
